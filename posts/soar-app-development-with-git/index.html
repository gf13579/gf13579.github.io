<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Soar App Development With VS Code and Git | spinning plates</title><meta name=keywords content><meta name=description content="Security automation typically involves making connections to services - typically APIs both internal (e.g AD) and external (e.g. VirusTotal). Splunk&rsquo;s SOAR solution has a large library of apps but it&rsquo;s a pretty common requirement to connect to a service that doesn&rsquo;t yet have an app.
SOAR makes it fairly easy to develop custom apps (connectors), which help abstract away some of the pain points of working with an API - including authentication, pagination, transformation of returned content and error handling."><meta name=author content><link rel=canonical href=https://spinningplates.net/posts/soar-app-development-with-git/><link crossorigin=anonymous href=/assets/css/stylesheet.faeb00df757dc3b73e8e251d8461633d065be58338a3336b4a81564cefcf240f.css integrity="sha256-+usA33V9w7c+jiUdhGFjPQZb5YM4ozNrSoFWTO/PJA8=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://spinningplates.net/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://spinningplates.net/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://spinningplates.net/favicon-32x32.png><link rel=apple-touch-icon href=https://spinningplates.net/apple-touch-icon.png><link rel=mask-icon href=https://spinningplates.net/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Soar App Development With VS Code and Git"><meta property="og:description" content="Security automation typically involves making connections to services - typically APIs both internal (e.g AD) and external (e.g. VirusTotal). Splunk&rsquo;s SOAR solution has a large library of apps but it&rsquo;s a pretty common requirement to connect to a service that doesn&rsquo;t yet have an app.
SOAR makes it fairly easy to develop custom apps (connectors), which help abstract away some of the pain points of working with an API - including authentication, pagination, transformation of returned content and error handling."><meta property="og:type" content="article"><meta property="og:url" content="https://spinningplates.net/posts/soar-app-development-with-git/"><meta property="og:image" content="https://spinningplates.net/vscode-commit.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-03-09T14:23:18+10:00"><meta property="article:modified_time" content="2023-03-09T14:23:18+10:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://spinningplates.net/vscode-commit.png"><meta name=twitter:title content="Soar App Development With VS Code and Git"><meta name=twitter:description content="Security automation typically involves making connections to services - typically APIs both internal (e.g AD) and external (e.g. VirusTotal). Splunk&rsquo;s SOAR solution has a large library of apps but it&rsquo;s a pretty common requirement to connect to a service that doesn&rsquo;t yet have an app.
SOAR makes it fairly easy to develop custom apps (connectors), which help abstract away some of the pain points of working with an API - including authentication, pagination, transformation of returned content and error handling."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://spinningplates.net/posts/"},{"@type":"ListItem","position":2,"name":"Soar App Development With VS Code and Git","item":"https://spinningplates.net/posts/soar-app-development-with-git/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Soar App Development With VS Code and Git","name":"Soar App Development With VS Code and Git","description":"Security automation typically involves making connections to services - typically APIs both internal (e.g AD) and external (e.g. VirusTotal). Splunk\u0026rsquo;s SOAR solution has a large library of apps but it\u0026rsquo;s a pretty common requirement to connect to a service that doesn\u0026rsquo;t yet have an app.\nSOAR makes it fairly easy to develop custom apps (connectors), which help abstract away some of the pain points of working with an API - including authentication, pagination, transformation of returned content and error handling.","keywords":[],"articleBody":"Security automation typically involves making connections to services - typically APIs both internal (e.g AD) and external (e.g. VirusTotal). Splunk’s SOAR solution has a large library of apps but it’s a pretty common requirement to connect to a service that doesn’t yet have an app.\nSOAR makes it fairly easy to develop custom apps (connectors), which help abstract away some of the pain points of working with an API - including authentication, pagination, transformation of returned content and error handling. SOAR’s App Wizard is an excellent tool for generating the bare bones of an app, including a lot of boilerplate code and comments that help explain what needs to be done to make the app useful.\nWhile SOAR makes heavy use of Git for version control of playbooks, it doesn’t use Git for apps. In addition, the Wizard’s code editor is functional, but lacks standard IDE features like linting and autocompletion, and quickly becomes frustrating to work with.\nIn this post we’ll use the Wizard to generate an app in our lab instance of SOAR, then switch to VS Code - editing remotely over SSH - and Git to further develop and manage the application whilst making it easy to apply changes for testing. Once deployed, the resulting app is still compatible with the Wizard - tactical changes could be made using SOAR’s UI, if required.\nIn addition to the benefits of a full IDE and source code control, we’ll use Git hooks to trigger code validation on commit, highlighting problems to fix before deploying and testing the change.\nCreate a New App Using the Wizard Use Apps-\u003eApp Wizard to create a new app. Hover over the question marks for useful guidance:\nAdd at least one action - ideally all the actions you expect to need to develop:\nConfigure the action. Don’t worry about the REST Endpoint parameter being correct - you can modify it later, and you may well choose not to use the autogenerated code.\nSave and publish the app:\nAt this point we have a new app folder within …/soar/apps/\nls -rlta | tail -n 1 phantom phantom 215 Feb 28 11:17 supertool9000_fbaeb1b3-fbe4-4356-a3c8-7e9b35986832 Notable files:\nsupertool9000.json supertool9000_consts.py supertool9000_connector.py readme.html Moving to VS Code and Git Copy the current version to a working folder:\ncp -r /opt/soar/apps/supertool9000_fbaeb1b3-fbe4-4356-a3c8-7e9b35986832/ ~/supertool9000_working Use VS Code to open that folder remotely over SSH:\nCreate a .gitignore file containing:\n__pycache__/* *.py[cod] Initialise the folder as a Git repo:\nYou may need to re-open the folder for VS Code to recognise this folder as being a repo, at which point you’ll have pending changes to commit:\nAdd a remote origin, or just use Code’s convenient support for publishing to GitHub:\nCreate a hooks folder under .git/ and create two files:\nMake them executable - note that you can just use the terminal within VS Code:\nPopulate the files: pre-commit:\n#!/opt/soar/usr/bin/python3 import subprocess import sys result = subprocess.run([\"phenv\", \"compile_app\", \"-c\", \"--no-color\"], capture_output=False, text=True) print(result.stdout) print(result.stderr, file=sys.stderr) exit(result.returncode) and post-commit\n#!/opt/soar/usr/bin/python3 import json import glob import re import subprocess import tempfile from shutil import copytree, copy2, ignore_patterns import sys def increment_ver(version): version = version.split('.') version[2] = str(int(version[2]) + 1) return '.'.join(version) file_name = re.sub(\"_connector.py\", \".json\", glob.glob(\"*_connector.py\")[0]) config = {} with open(file_name, mode='r') as f: config = json.loads(f.read()) config['app_version'] = increment_ver(config['app_version']) with open(file_name, mode='w') as f: f.write(json.dumps(config)) with tempfile.TemporaryDirectory() as dirpath: copytree(\".\", dirpath, symlinks=False, ignore=ignore_patterns('.git*'), copy_function=copy2, ignore_dangling_symlinks=False, dirs_exist_ok=True) result = subprocess.run([\"phenv\", \"compile_app\", \"-i\", \"--no-color\"], capture_output=True, text=True, cwd=dirpath) print(result.stdout) print(result.stderr, file=sys.stderr) exit(result.returncode) The pre-commit app compile action should cause the commit to fail - with the compile_app output visible in the Git log - if there’s a problem compiling the app.\nTo test the commit/compile workflow:\nConfirm the value of app_version in your app’s .json file. Confirm the version visible within the SOAR web UI Make an arbitrary change to your connector’s [appname]_connector.py file e.g. add a # comment Make a commit within VS Code Confirm the latest patch version within the web UI has been incremented Notes:\nThe patch version will always end up one greater in the local copy of the app’s json config file i.e. pending a commit i.e. think of this version as being the next version of the app you’re working on If you ever want to update the major or minor versions in the semantic version (major.minor.patch), do so manually Basic errors will cause app compilation - and thus the pre-commit check - to fail:\nThe log gives us more details and a link to the offending code:\nNote that we could’ve made use of a linter in Code to identify the issue before compiling the code:\nAdd # type ignore to tell VS Code’s Pylance language server to ignore errors importing Phantom (SOAR) modules:\nimport phantom.app as phantom # type: ignore from phantom.base_connector import BaseConnector # type: ignore from phantom.action_result import ActionResult # type: ignore Tactical Deployment for quick code change tests Rather than commit and compile the app for every single code change, let’s add a build task that will all .py files over from the working directory to the app’s directory within /opt/soar/apps:\nUse Code’s command palette to create a task - or just create .vscode/tasks.json:\n{ \"version\": \"2.0.0\", \"tasks\": [ { \"label\": \"Copy py files to live soar app folder\", \"type\": \"shell\", \"command\": \"which jq \u0026\u0026 cp *.py $(echo \\\"/opt/soar/apps/$(jq .directory $(ls *_connector.py | sed \\\"s/_connector.py/.json/\\\") -r)\\\")/\", \"problemMatcher\": [], \"group\": { \"kind\": \"build\", \"isDefault\": true } } ] } We can now use Run Build Task (Ctrl + Shift + B) to quickly update the Python files directly within our running SOAR instance’s /apps directory.\nThe command above is a bash one-liner that:\nConfirms jq is available Gets the app name from [appname]_connector.py Uses that name to retrieve the app’s json config file Uses jq to parse the value of directory i.e. the appname_[guid] value Copies .py files from the current folder to that app directory within /opt/soar/apps (hard coded - change as required) Adding Dependencies The App Wizard supports adding dependencies - as pypi references or manual wheel (.whl) file uploads.\nTo add a pypi dependency outside of the Wizard, add/edit the following property in the root of the app’s json config file:\n\"pip3_dependencies\": { \"pypi\": [ { \"module\": \"xmltodict\" } ] } Compiling the app with compile_app should result in the relevant dependencies being downloaded and placed in a /dependencies directory, created if it didn’t already exist. This directory is populated for the installed copy of the application - under [path_to_soar]/apps/[app_name]_[guid].\nSpecifying Output Data Paths Adding output data paths - even within the App Wizard’s UI - involves manually updating the app’s json-based config file.\nIf the API call returns a list of objects, each with an id value, here’s how we might represent that in the app’s json file, so that SOAR’s playbook editor offers the developer known action result paths within the UI:\n\"output\": [ { \"data_path\": \"action_result.parameter.ip\", \"data_type\": \"string\", \"contains\": [ \"ip\" ], \"column_name\": \"IP (Parameter)\", \"column_order\": 0 }, { \"data_path\": \"action_result.data.*.id\", \"data_type\": \"numeric\", \"column_name\": \"ID\", \"column_order\": 1 }, Making REST Calls - Wizard-generated Code The SOAR App Wizard generates a lot of skeleton code including utility functions designed to simplify making REST calls and handling responses. Most of this code can safely be deleted if you’re choosing to handle this yourself - e.g. using a separate Python module that abstracts the complexity of connecting to a given service. Functions that could be removed include:\n_process_empty_response _process_html_response _process_json_response _process_response _make_rest_call Summary In this article we created a SOAR app within the UI then switched to further the develop it in VS Code and manage the codebase in Git. Future posts may cover remote debugging and CI/CD.\nCheck out Splunk’s documentation, which covers much of what’s required to make an app useful, including a full API reference and functional tutorial to develop a connector for ipinfo.io from scratch. Also take a look at their VS Code Extension for further interacting with your SOAR instance during development.\n","wordCount":"1321","inLanguage":"en","datePublished":"2023-03-09T14:23:18+10:00","dateModified":"2023-03-09T14:23:18+10:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://spinningplates.net/posts/soar-app-development-with-git/"},"publisher":{"@type":"Organization","name":"spinning plates","logo":{"@type":"ImageObject","url":"https://spinningplates.net/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://spinningplates.net/ accesskey=h title="spinning plates (Alt + H)">spinning plates</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Soar App Development With VS Code and Git</h1><div class=post-meta><span title='2023-03-09 14:23:18 +1000 +1000'>March 9, 2023</span></div></header><div class=post-content><p>Security automation typically involves making connections to services - typically APIs both internal (e.g AD) and external (e.g. VirusTotal). Splunk&rsquo;s SOAR solution has a <a href=https://github.com/splunk-soar-connectors>large library of apps</a> but it&rsquo;s a pretty common requirement to connect to a service that doesn&rsquo;t yet have an app.</p><p>SOAR makes it fairly easy to develop custom apps (connectors), which help abstract away some of the pain points of working with an API - including authentication, pagination, transformation of returned content and error handling. SOAR&rsquo;s App Wizard is an excellent tool for generating the bare bones of an app, including a lot of boilerplate code and comments that help explain what needs to be done to make the app useful.</p><p>While SOAR makes heavy use of Git for version control of playbooks, it doesn&rsquo;t use Git for apps. In addition, the Wizard&rsquo;s code editor is functional, but lacks standard IDE features like linting and autocompletion, and quickly becomes frustrating to work with.</p><p>In this post we&rsquo;ll use the Wizard to generate an app in our lab instance of SOAR, then switch to VS Code - editing remotely over SSH - and Git to further develop and manage the application whilst making it easy to apply changes for testing. Once deployed, the resulting app is still compatible with the Wizard - tactical changes could be made using SOAR&rsquo;s UI, if required.</p><p>In addition to the benefits of a full IDE and source code control, we&rsquo;ll use Git hooks to trigger code validation on commit, highlighting problems to fix before deploying and testing the change.</p><h2 id=create-a-new-app-using-the-wizard>Create a New App Using the Wizard<a hidden class=anchor aria-hidden=true href=#create-a-new-app-using-the-wizard>#</a></h2><p>Use Apps->App Wizard to create a new app. Hover over the question marks for useful guidance:</p><p><a href=appwiz-example.png><img loading=lazy src=appwiz-example.png alt></a></p><p>Add at least one action - ideally all the actions you expect to need to develop:</p><p><a href=appwiz-add-action.png><img loading=lazy src=appwiz-add-action.png alt></a></p><p>Configure the action. Don’t worry about the REST Endpoint parameter being correct - you can modify it later, and you may well choose not to use the autogenerated code.</p><p><a href=appwiz-add-action-example.png><img loading=lazy src=appwiz-add-action-example.png alt></a></p><p>Save and publish the app:</p><p><a href=appwiz-save-and-publish.png><img loading=lazy src=appwiz-save-and-publish.png alt></a></p><p>At this point we have a new app folder within &mldr;/soar/apps/</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ls -rlta | tail -n <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>phantom phantom   <span style=color:#ae81ff>215</span> Feb <span style=color:#ae81ff>28</span> 11:17 supertool9000_fbaeb1b3-fbe4-4356-a3c8-7e9b35986832
</span></span></code></pre></div><p>Notable files:</p><ul><li>supertool9000.json</li><li>supertool9000_consts.py</li><li>supertool9000_connector.py</li><li>readme.html</li></ul><h2 id=moving-to-vs-code-and-git>Moving to VS Code and Git<a hidden class=anchor aria-hidden=true href=#moving-to-vs-code-and-git>#</a></h2><p>Copy the current version to a working folder:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cp -r /opt/soar/apps/supertool9000_fbaeb1b3-fbe4-4356-a3c8-7e9b35986832/ ~/supertool9000_working
</span></span></code></pre></div><p>Use VS Code to open that folder remotely over SSH:</p><p><a href=vscode-remote-open-folder.png><img loading=lazy src=vscode-remote-open-folder.png alt></a></p><p>Create a .gitignore file containing:</p><pre tabindex=0><code>__pycache__/*
*.py[cod]
</code></pre><p>Initialise the folder as a Git repo:</p><p><a href=vscode-initialize-as-repo.png><img loading=lazy src=vscode-initialize-as-repo.png alt></a></p><p>You may need to re-open the folder for VS Code to recognise this folder as being a repo, at which point you’ll have pending changes to commit:</p><p><a href=vscode-commit.png><img loading=lazy src=vscode-commit.png alt></a></p><p>Add a remote origin, or just use Code’s convenient support for publishing to GitHub:</p><p><a href=%5Bpublish-to-github%5D.png><img loading=lazy src=publish-to-github.png alt></a></p><p>Create a hooks folder under <code>.git/</code> and create two files:</p><p><a href=vscode-hooks.png><img loading=lazy src=vscode-hooks.png alt></a></p><p>Make them executable - note that you can just use the terminal within VS Code:</p><p><a href=vscode-chmod.png><img loading=lazy src=vscode-chmod.png alt></a></p><p>Populate the files: <code>pre-commit</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#!/opt/soar/usr/bin/python3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> subprocess
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> sys
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>result <span style=color:#f92672>=</span> subprocess<span style=color:#f92672>.</span>run([<span style=color:#e6db74>&#34;phenv&#34;</span>, <span style=color:#e6db74>&#34;compile_app&#34;</span>, <span style=color:#e6db74>&#34;-c&#34;</span>, <span style=color:#e6db74>&#34;--no-color&#34;</span>],
</span></span><span style=display:flex><span>                        capture_output<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>, text<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>print(result<span style=color:#f92672>.</span>stdout)
</span></span><span style=display:flex><span>print(result<span style=color:#f92672>.</span>stderr, file<span style=color:#f92672>=</span>sys<span style=color:#f92672>.</span>stderr)
</span></span><span style=display:flex><span>exit(result<span style=color:#f92672>.</span>returncode)
</span></span></code></pre></div><p>and <code>post-commit</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#!/opt/soar/usr/bin/python3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> json
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> glob
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> re
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> subprocess
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> tempfile
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> shutil <span style=color:#f92672>import</span> copytree, copy2, ignore_patterns
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> sys
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>increment_ver</span>(version):
</span></span><span style=display:flex><span>    version <span style=color:#f92672>=</span> version<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#39;.&#39;</span>)
</span></span><span style=display:flex><span>    version[<span style=color:#ae81ff>2</span>] <span style=color:#f92672>=</span> str(int(version[<span style=color:#ae81ff>2</span>]) <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#39;.&#39;</span><span style=color:#f92672>.</span>join(version)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>file_name <span style=color:#f92672>=</span> re<span style=color:#f92672>.</span>sub(<span style=color:#e6db74>&#34;_connector.py&#34;</span>, <span style=color:#e6db74>&#34;.json&#34;</span>, glob<span style=color:#f92672>.</span>glob(<span style=color:#e6db74>&#34;*_connector.py&#34;</span>)[<span style=color:#ae81ff>0</span>])
</span></span><span style=display:flex><span>config <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> open(file_name, mode<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;r&#39;</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>    config <span style=color:#f92672>=</span> json<span style=color:#f92672>.</span>loads(f<span style=color:#f92672>.</span>read())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>config[<span style=color:#e6db74>&#39;app_version&#39;</span>] <span style=color:#f92672>=</span> increment_ver(config[<span style=color:#e6db74>&#39;app_version&#39;</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> open(file_name, mode<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;w&#39;</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>    f<span style=color:#f92672>.</span>write(json<span style=color:#f92672>.</span>dumps(config))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> tempfile<span style=color:#f92672>.</span>TemporaryDirectory() <span style=color:#66d9ef>as</span> dirpath:
</span></span><span style=display:flex><span>    copytree(<span style=color:#e6db74>&#34;.&#34;</span>, dirpath, symlinks<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>, ignore<span style=color:#f92672>=</span>ignore_patterns(<span style=color:#e6db74>&#39;.git*&#39;</span>),
</span></span><span style=display:flex><span>             copy_function<span style=color:#f92672>=</span>copy2, ignore_dangling_symlinks<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>, dirs_exist_ok<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>    result <span style=color:#f92672>=</span> subprocess<span style=color:#f92672>.</span>run([<span style=color:#e6db74>&#34;phenv&#34;</span>, <span style=color:#e6db74>&#34;compile_app&#34;</span>, <span style=color:#e6db74>&#34;-i&#34;</span>, <span style=color:#e6db74>&#34;--no-color&#34;</span>],
</span></span><span style=display:flex><span>                            capture_output<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, text<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, cwd<span style=color:#f92672>=</span>dirpath)
</span></span><span style=display:flex><span>    print(result<span style=color:#f92672>.</span>stdout)
</span></span><span style=display:flex><span>    print(result<span style=color:#f92672>.</span>stderr, file<span style=color:#f92672>=</span>sys<span style=color:#f92672>.</span>stderr)
</span></span><span style=display:flex><span>    exit(result<span style=color:#f92672>.</span>returncode)
</span></span></code></pre></div><p>The <code>pre-commit</code> app compile action should cause the commit to fail - with the <code>compile_app</code> output visible in the Git log - if there’s a problem compiling the app.</p><p>To test the commit/compile workflow:</p><ol><li>Confirm the value of app_version in your app&rsquo;s .json file.</li><li>Confirm the version visible within the SOAR web UI</li><li>Make an arbitrary change to your connector’s [appname]_connector.py file e.g. add a <code># comment</code></li><li>Make a commit within VS Code</li><li>Confirm the latest patch version within the web UI has been incremented</li></ol><p>Notes:</p><ul><li>The patch version will always end up one greater in the local copy of the app’s json config file i.e. pending a commit i.e. think of this version as being the next version of the app you’re working on</li><li>If you ever want to update the major or minor versions in the semantic version (major.minor.patch), do so manually</li></ul><p>Basic errors will cause app compilation - and thus the pre-commit check - to fail:</p><p><a href=git-error-on-commit.png><img loading=lazy src=git-error-on-commit.png alt></a></p><p>The log gives us more details and a link to the offending code:</p><p><a href=git-error-on-commit-log.png><img loading=lazy src=git-error-on-commit-log.png alt></a></p><p>Note that we could&rsquo;ve made use of a linter in Code to identify the issue before compiling the code:</p><p><a href=linting-errors.png><img loading=lazy src=linting-errors.png alt></a></p><p>Add <code># type ignore</code> to tell VS Code’s Pylance language server to ignore errors importing Phantom (SOAR) modules:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> phantom.app <span style=color:#66d9ef>as</span> phantom  <span style=color:#75715e># type: ignore</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> phantom.base_connector <span style=color:#f92672>import</span> BaseConnector  <span style=color:#75715e># type: ignore</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> phantom.action_result <span style=color:#f92672>import</span> ActionResult  <span style=color:#75715e># type: ignore</span>
</span></span></code></pre></div><h2 id=tactical-deployment-for-quick-code-change-tests>Tactical Deployment for quick code change tests<a hidden class=anchor aria-hidden=true href=#tactical-deployment-for-quick-code-change-tests>#</a></h2><p>Rather than commit and compile the app for every single code change, let&rsquo;s add a build task that will all .py files over from the working directory to the app&rsquo;s directory within <code>/opt/soar/apps</code>:</p><p>Use Code&rsquo;s command palette to create a task - or just create <code>.vscode/tasks.json</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;version&#34;</span>: <span style=color:#e6db74>&#34;2.0.0&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;tasks&#34;</span>: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;label&#34;</span>: <span style=color:#e6db74>&#34;Copy py files to live soar app folder&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;shell&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;command&#34;</span>: <span style=color:#e6db74>&#34;which jq &amp;&amp; cp *.py $(echo \&#34;/opt/soar/apps/$(jq .directory $(ls *_connector.py | sed \&#34;s/_connector.py/.json/\&#34;) -r)\&#34;)/&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;problemMatcher&#34;</span>: [],
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;group&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;kind&#34;</span>: <span style=color:#e6db74>&#34;build&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;isDefault&#34;</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We can now use Run Build Task (Ctrl + Shift + B) to quickly update the Python files directly within our running SOAR instance&rsquo;s <code>/apps</code> directory.</p><p>The <code>command</code> above is a bash one-liner that:</p><ul><li>Confirms <code>jq</code> is available</li><li>Gets the app name from [appname]_connector.py</li><li>Uses that name to retrieve the app&rsquo;s json config file</li><li>Uses <code>jq</code> to parse the value of <code>directory</code> i.e. the appname_[guid] value</li><li>Copies .py files from the current folder to that app directory within <code>/opt/soar/apps</code> (hard coded - change as required)</li></ul><h2 id=adding-dependencies>Adding Dependencies<a hidden class=anchor aria-hidden=true href=#adding-dependencies>#</a></h2><p>The App Wizard supports adding dependencies - as pypi references or manual wheel (.whl) file uploads.</p><p>To add a pypi dependency outside of the Wizard, add/edit the following property in the root of the app’s json config file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#e6db74>&#34;pip3_dependencies&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;pypi&#34;</span>: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;module&#34;</span>: <span style=color:#e6db74>&#34;xmltodict&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Compiling the app with <code>compile_app</code> should result in the relevant dependencies being downloaded and placed in a <code>/dependencies</code> directory, created if it didn’t already exist. This directory is populated for the installed copy of the application - under <code>[path_to_soar]/apps/[app_name]_[guid]</code>.</p><h2 id=specifying-output-data-paths>Specifying Output Data Paths<a hidden class=anchor aria-hidden=true href=#specifying-output-data-paths>#</a></h2><p>Adding output data paths - even within the App Wizard’s UI - involves manually updating the app’s json-based config file.</p><p>If the API call returns a list of objects, each with an <code>id</code> value, here’s how we might represent that in the app’s json file, so that SOAR’s playbook editor offers the developer known action result paths within the UI:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#e6db74>&#34;output&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;data_path&#34;</span>: <span style=color:#e6db74>&#34;action_result.parameter.ip&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;data_type&#34;</span>: <span style=color:#e6db74>&#34;string&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;contains&#34;</span>: [
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;ip&#34;</span>
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;column_name&#34;</span>: <span style=color:#e6db74>&#34;IP (Parameter)&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;column_order&#34;</span>: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;data_path&#34;</span>: <span style=color:#e6db74>&#34;action_result.data.*.id&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;data_type&#34;</span>: <span style=color:#e6db74>&#34;numeric&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;column_name&#34;</span>: <span style=color:#e6db74>&#34;ID&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;column_order&#34;</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    },
</span></span></code></pre></div><h2 id=making-rest-calls---wizard-generated-code>Making REST Calls - Wizard-generated Code<a hidden class=anchor aria-hidden=true href=#making-rest-calls---wizard-generated-code>#</a></h2><p>The SOAR App Wizard generates a lot of skeleton code including utility functions designed to simplify making REST calls and handling responses. Most of this code can safely be deleted if you’re choosing to handle this yourself - e.g. using a separate Python module that abstracts the complexity of connecting to a given service. Functions that could be removed include:</p><ul><li>_process_empty_response</li><li>_process_html_response</li><li>_process_json_response</li><li>_process_response</li><li>_make_rest_call</li></ul><h2 id=summary>Summary<a hidden class=anchor aria-hidden=true href=#summary>#</a></h2><p>In this article we created a SOAR app within the UI then switched to further the develop it in VS Code and manage the codebase in Git. Future posts may cover remote debugging and CI/CD.</p><p>Check out Splunk&rsquo;s <a href=https://docs.splunk.com/Documentation/SOAR/current/DevelopApps/Overview>documentation</a>, which covers much of what&rsquo;s required to make an app useful, including a full API reference and functional tutorial to develop a connector for ipinfo.io from scratch. Also take a look at their <a href="https://marketplace.visualstudio.com/items?itemName=Splunk.vscode-splunk-soar">VS Code Extension</a> for further interacting with your SOAR instance during development.</p></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><footer class=footer><span>&copy; 2023 <a href=https://spinningplates.net/>Greg Ford.</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>